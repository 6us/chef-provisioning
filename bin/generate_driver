#!/usr/bin/env chef-apply

driver_name = ARGV[1]

if driver_name.nil? || driver_name.empty?
  abort "Please provide a name for the generated driver (it will be generated into a subdirectory)."
end

snake_name = driver_name.downcase.gsub('-', '_')
snake_driver = "#{snake_name}_driver"
driver_dir = "#{ENV['PWD']}/chef-provisioning-#{driver_name}"

camel_name = snake_name.split(/[_-]/).collect(&:capitalize).join

# gross.
`mkdir #{driver_dir} || true`
Dir.chdir driver_dir

def prefix(subpath)
  "lib/chef/provisioning/#{subpath}"
end

# -----------------------------------------
# driver_init/
directory prefix("driver_init") do
  recursive true
end

# -----------------------------------------
# driver_init/dummy.rb
file prefix("driver_init/#{snake_name}.rb") do
  content <<-EOS
require 'chef/provisioning/#{snake_driver}/driver'
Chef::Provisioning.register_driver_class('#{snake_name}', Chef::Provisioning::#{camel_name}Driver::Driver)
  EOS
end

# -----------------------------------------
# dummy_driver.rb
file prefix("#{snake_driver}.rb") do
  content <<-EOS
require 'chef/provisioning'
require 'chef/provisioning/#{snake_driver}/driver'
  EOS
end

# -----------------------------------------
# dummy_driver/
directory prefix("#{snake_driver}") do
  recursive true
end

# -----------------------------------------
# dummy_driver/version.rb
file prefix("#{snake_driver}/version.rb") do
  content <<-EOS
class Chef
module Provisioning
module #{camel_name}Driver
  VERSION = '0.1'
end
end
end
EOS
end

# -----------------------------------------
# dummy_driver/driver.rb
file prefix("#{snake_driver}/driver.rb") do
  content <<-EOS
require 'chef/provisioning/driver'
require 'chef/provisioning/#{snake_driver}/version'

class Chef
module Provisioning
module #{camel_name}Driver
  class Driver < Chef::Provisioning::Driver

    # generated by script, required by API.
    def self.canonicalize_url(driver_url, config)
      [ "fake:\#{driver_url} [not the real URL]", config ]
    end

    # generated by script, required by API.
    def self.from_url(driver_url, config)
      Driver.new(driver_url, config)
    end
  end
end
end
end
  EOS
end

# -----------------------------------------
execute "rspec --init" do
  cwd driver_dir
  not_if { File.exist?("spec") }
end

file ".rspec" do
  content <<-EOS
--color
--require spec_helper
-fd
  EOS
end

# -----------------------------------------
# spec/spec_helper.rb
file "spec/spec_helper.rb" do
  content <<-EOS
require '#{snake_name}_support'

RSpec.configure do |config|
  config.expect_with :rspec do |expectations|
    # This option will default to `true` in RSpec 4. It makes the `description`
    # and `failure_message` of custom matchers include text for helper methods
    # defined using `chain`, e.g.:
    #     be_bigger_than(2).and_smaller_than(4).description
    #     # => "be bigger than 2 and smaller than 4"
    # ...rather than:
    #     # => "be bigger than 2"
    expectations.include_chain_clauses_in_custom_matcher_descriptions = true
  end

  config.mock_with :rspec do |mocks|
    mocks.verify_partial_doubles = true
  end

  config.filter_run :focus
  config.run_all_when_everything_filtered = true
end
  EOS
end

# -----------------------------------------
# spec/dummy_spec.rb
file "spec/#{snake_name}_spec.rb" do
  content <<-EOS
describe "Chef::Provisioning::#{camel_name}" do
  extend #{camel_name}Support
  # include #{camel_name}Config   # uncomment to get `chef_config` or to mix in code.

  when_the_chef_12_server "exists", server_scope: :context, port: 8900..9000 do
    with_#{snake_name} "integration tests" do
      context "machine resource" do
        it "doesn't run any tests" do
        end
      end
    end
  end
end
  EOS
end

# -----------------------------------------
# spec/dummy_support.rb
file "spec/#{snake_name}_support.rb" do
  content <<-EOS
module #{camel_name}Support

  # your top-level context blocks will use this file like so:
  # require "#{snake_name}_support"
  #
  # describe "Chef::Provisioning::#{camel_name}" do
  #   extend #{camel_name}Support
  #   # include #{camel_name}Config   # optional, gives you a `chef_config` object.

  require 'cheffish/rspec/chef_run_support'

  # when you `extend #{camel_name}Support`, your RSpec-context-extending-`#{camel_name}Support` with then
  # further `extend ChefRunSupport` to acquire all of the latter's Lucky Charms.
  def self.extended(other)
    other.extend Cheffish::RSpec::ChefRunSupport
  end

  # this creates a `with_#{snake_name}` block method that saves you the repetition of having to load the
  # driver code, and gives you a common place to put any other driver setup for your specs.
  #
  # subtle stuff here. it looks weird because you're taking a block and putting that inside a new block and
  # then giving *that* to a Cheffish method which will run it for you in the context of a local chef-zero.

  def with_#{snake_name}(description, *tags, &block)

    # take the block you just passed in, and make a new Proc that will call it after loading the driver...
    context_block = proc do
      #{snake_driver} = Chef::Provisioning.driver_for_url("#{snake_name}")

      @@driver = #{snake_driver}
      def self.driver
        @@driver
      end

      # when this Proc runs, this will run the block you just passed to `with_#{snake_name}`...
      module_eval(&block)
    end

    # ...now pass that Proc to `Cheffish::RSpec::ChefRunSupport#when_the_repository`, which will:
    # 1. start up a chef-zero with `*tags` as the parameters, and
    # 2. run your `context_block` Proc (which contains your original `&block`) using that chef-zero.
    when_the_repository "exists and \#{description}", *tags, &context_block
  end
end

# optional, I'm not sure where I cargo-culted this from.
module #{camel_name}Config
  def chef_config
    @chef_config ||= {
      driver: Chef::Provisioning.driver_for_url("#{snake_name}"),
    }
  end
end
EOS
end

# -----------------------------------------
file "Gemfile" do
  content <<-EOS
source "https://rubygems.org"
gem "chef", ">= 12.4.1"
gem "cheffish"
gem "chef-provisioning"
  EOS
end

# -----------------------------------------
log "If you'd like to package this as a gem, start with the following command: 'bundle gem chef-provisioning-#{driver_name}'" do
  not_if { File.exist?("chef-provisioning-#{driver_name}.gemspec") }
end
